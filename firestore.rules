rules_version = '2';

/**
 * @name Firebase Security Rules for BookVerse API
 * @file firestore.rules
 *
 * @description
 * This ruleset provides security for the BookVerse Firestore database.
 *
 * @philosophy
 * The core philosophy is a role-based and ownership-based security model.
 * There are two primary roles: Customers and Admins.
 * - **Admins**: Identified by the existence of a document in the `/roles_admin`
 *   collection. They have full CRUD access to the public book catalog and can
 *   view and manage all orders.
 * - **Customers (Signed-in Users)**: Can manage their own user profile,
 *   their own orders and shopping cart. They have read-only access to the public book catalog.
 * - **Public (Unauthenticated Users)**: Can read the book catalog but cannot
 *   write any data.
 *
 * @structure
 * - `/books/{bookId}`: A public collection of all books.
 * - `/users/{userId}`: A collection for user profiles. Access is strictly
 *   limited to the document owner.
 * - `/users/{userId}/cart/{bookId}`: A subcollection for a user's shopping cart items.
 * - `/users/{userId}/orders/{orderId}`: A subcollection for a user's orders.
 * - `/orders/{orderId}`: A denormalized collection of all orders for admin access.
 * - `/roles_admin/{userId}`: A special collection where the existence of a
 *   document signifies that the user is an administrator.
 *
 * @decisions
 * - **Admin Role Management**: Admin status is determined by checking for the
 *   existence of a document in `/roles_admin/{userId}`. This is a secure and
 *   performant pattern.
 * - **Strict Data Privacy**: User data (profiles, cart) is strictly private.
 *   Admins do not have read/write access to individual user profiles.
 * - **Denormalization for Admin Queries**: The top-level `/orders` collection
 *   contains copies of all orders. This allows admins to list and manage all
 *   orders without needing to query across all user subcollections, which is
 *   not possible with security rules.
 *
 */
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * @name isSignedIn
     * @description Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @name isOwner
     * @description Checks if the authenticated user's UID matches the provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @name isAdmin
     * @description Checks if the user has an admin role by verifying the
     *              existence of their UID in the roles_admin collection.
     *              This is a fast and secure existence-only check.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @name isExistingDoc
     * @description Checks if the document being operated on currently exists.
     *              Crucial for all update and delete operations.
     */
    function isExistingDoc() {
      return resource != null;
    }

    /**
     * @name isExistingOwner
     * @description Combines ownership and existence checks for secure updates and deletes.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && isExistingDoc();
    }
    
    /**
     * @name isExistingAdmin
     * @description Combines admin and existence checks for secure updates and deletes by admins.
     */
    function isExistingAdmin() {
      return isAdmin() && isExistingDoc();
    }

    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description Public book catalog. Readable by anyone, writable only by admins.
     * @path /books/{bookId}
     */
    match /books/{bookId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description User profile data. A user can only access their own document.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);

      /**
       * @description A user's shopping cart items. Only the owner can manage their cart.
       * @path /users/{userId}/cart/{bookId}
       */
      match /cart/{bookId} {
        allow get, list, create, update, delete: if isOwner(userId);
      }

      /**
       * @description A user's orders. Only the owner can manage their own orders.
       * @path /users/{userId}/orders/{orderId}
       */
      match /orders/{orderId} {
        allow get, list, create, update, delete: if isOwner(userId);
      }
    }
    
    /**
     * @description Denormalized collection of all orders for admin access.
     * @path /orders/{orderId}
     */
    match /orders/{orderId} {
      // Admins can manage all orders
      allow get, list, update: if isAdmin();
      
      // Users can only create their own order document here. They cannot read or list all orders.
      // This write happens in the same transaction as creating the user-specific order.
      allow create: if isOwner(request.resource.data.userId);

      // Deny reads/deletes for non-admins to prevent them from accessing other users' orders.
      allow delete: if isAdmin();
    }

    /**
     * @description Admin role management. Only other admins can view or modify this collection.
     * @path /roles_admin/{userId}
     */
    match /roles_admin/{userId} {
      allow get, list, create, update, delete: if isAdmin();
    }
  }
}
